!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).Octomments=n()}(this,function(){"use strict";function t(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function n(t,n){n=n||window.location.href,t=t.replace(/[\[\]]/g,"\\$&");var e=RegExp("[?&]".concat(t,"(=([^&#]*)|&|#|$)")).exec(n);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function e(t){return["code","error","error_description","error_uri","t"].forEach(function(n){t=t.replace(RegExp("[?&]".concat(n,"=[^&]+")),"")}),t}function o(t){return{id:t.id,url:t.html_url,author:{login:t.user.login,avatarUrl:t.user.avatar_url,url:t.user.html_url},body:t.body_html,createdAt:t.created_at,updatedAt:t.updated_at}}var a="ERROR",c="USER_LOADING",i="USER_NONE",r="USER_LOADED",s="COMMENTS_LOADING",u="COMMENTS_LOADED",m="COMMENT_SAVING",d="COMMENT_SAVED",l="OCTOMMENTS_USER",f=[a,s,u,m,c,i,r,d];function g(t,n){var e=t.notify,a=t.options,c=t.error,r=a.endpoints,m=a.issueNumber,d=a.github,l=!!r,f=Error("Error getting comments for issue #".concat(m,".")),g=Error("Issue #".concat(m," doesn't exists."));function v(t){console.error(t),c(f,2)}function h(t){return function(n,e){if(e)c(f,2);else if(n.ok)t(n);else{if(404===n.status)return c(g,1);t(n)}}}e(s),function n(a){var s=0<arguments.length&&void 0!==a?a:1;fetch("https://api.github.com/repos/".concat(d.owner,"/").concat(d.repo,"/issues/").concat(m,"/comments?page=").concat(s),{headers:t.getHeaders()}).then(h(function(a){if(!a.ok)return 401===a.status?(t.logout(!1),e(i),void n(s)):403===a.status?l?void fetch("".concat(r.issue,"?owner=").concat(d.owner,"&repo=").concat(d.repo,"&number=").concat(m)).then(h(function(n){n.ok?n.json().then(function(n){var o=n.issue.comments;t.data={comments:t.data.comments.concat(o),pagination:null},e(u,o,null)}).catch(function(t){console.error(t),c(Error("Error parsing the API response"),3)}):c(f,2)})).catch(v):c(Error("Rate limit exceeded."),4):c(f,2);var g=a.headers.get("Link"),p=null;g&&(p=function(t){var n=t.split(","),e={};for(var o in n){var a=n[o],c={};c.name=a.match(/rel=\"([^\"]*)/)[1],c.url=a.match(/<([^>]*)/)[1],c.page=parseInt(a.match(/page=(\d+).*$/)[1],10),e[c.name]=c}return e}(g)),a.json().then(function(n){var a=n.map(o);t.data={comments:t.data.comments.concat(a),pagination:p},e(u,a,p)}).catch(v)}))}(n)}function v(s){if(!s)throw Error("Octomments options required.");if(!s.github||!s.github.owner||!s.github.repo)throw Error("`options.github` is missing or incomplete.");if(!s.issueNumber)throw Error("`options.issueNumber` is missing.");s.endpoints||(s.endpoints={issue:"https://ocs.now.sh/octomments/issue",token:"https://ocs.now.sh/octomments/token"}),s.debug&&console.log("Octomments started with: ",JSON.stringify(s,null,2));var u={},v={user:null,data:{comments:[],pagination:null},options:s,LS:!0===function(){var t="test";try{return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(n){return!1}}()?localStorage:{setItem:function(){},getITem:function(){},removeItem:function(){}},error:function(t,n){v.notify(a,t,n)},notify:function(t){for(var n=arguments.length,e=Array(1<n?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];s.debug&&console.log(t,e),u[t]&&u[t].forEach(function(t){return t.apply(void 0,e)})}};if(v.initUser=function(){return function(t){function o(){return history.replaceState({},document.title,e(location.href))}var a=t.notify,s=t.error,u=t.generateNewCommentURL(),m=t.LS.getItem(l);if(m)try{t.user=JSON.parse(m),a(r,t.user,!1)}catch(d){console.error(d),s(Error("Corrupted data in local storage."),5)}else if(n("t")){var f=n("t");t.user={token:f},a(c),fetch("https://api.github.com/user",{headers:t.getHeaders()}).then(function(n,e){e||!n.ok?(e&&console.error(e),o(),s(Error("Problem getting user's info."),6)):n.json().then(function(n){t.user={token:t.user.token,login:n.login,avatarUrl:n.avatar_url,url:n.html_url,name:n.name},o(),t.LS.setItem(l,JSON.stringify(t.user)),a(r,t.user,!0)}).catch(function(t){console.error(t),s(Error("Problem parsing access token response."),7)})}).catch(function(t){console.error(t),s(Error("Problem getting access token."),6)})}else a(i,u)}(v)},v.initComments=function(){return g(v)},v.logout=function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];v.user=null,v.LS.removeItem(l),t&&location.reload()},v.add=function(t){if(!v.user)throw Error("No user logged in.");(function t(n,e){var a=n.notify,c=n.error,r=n.options,s=r.issueNumber,u=r.github,l=Error("Adding a new comment failed.");a(m);var f,g="https://api.github.com/repos/".concat(u.owner,"/").concat(u.repo,"/issues/").concat(s,"/comments");function v(t){console.error(t),c(l,10)}fetch(g,{method:"POST",headers:n.getHeaders(),body:JSON.stringify({body:e})}).then((f=function(t){a(d,[o(t)])},function(t,e){return e?c(l,8):t.ok?void t.json().then(function(t){t?f(t):c(Error("Parsing new-comment response failed."),10)}).catch(v):401===t.status?(n.logout(!1),a(i),c(Error("Not authorized. Log in again."),9)):403===t.status?c(Error("Rate limit exceeded."),4):c(l,8)})).catch(v)})(v,t)},v.off=function(t){return delete u[t],this},v.on=function(t,n){return u[t]||(u[t]=[]),u[t].push(n),this},v.init=function(){v.initUser(),v.initComments()},v.page=function(t){g(v,t)},v.generateNewCommentURL=function(){var t,n;return t=s.endpoints.token,n=e(window.location.href),"".concat(t,"?redirect=").concat(encodeURI(n))},v.getHeaders=function(){var t={"Content-Type":"application/json",Accept:"application/vnd.github.v3.html+json"};return v.user&&v.user.token&&(t.Authorization="token ".concat(v.user.token)),t},f.forEach(function(t){return v[t]=t}),s.renderer){var h,p,O=function(t){if(Array.isArray(t))return t}(h=s.renderer)||t(h)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance")}(),$=O[0],b=O.slice(1);$.apply(void 0,[v].concat(function(t){if(Array.isArray(t)){for(var n=0,e=Array(t.length);n<t.length;n++)e[n]=t[n];return e}}(p=b)||t(p)||function(){throw TypeError("Invalid attempt to spread non-iterable instance")}()))}return v}return f.forEach(function(t){return v[t]=t}),v.version="1.0.5",v}),function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).OctommentsRenderer=n()}(this,function(){"use strict";var t=function(t){var n=0<arguments.length&&void 0!==t?t:24;return'<svg width="'.concat(n,'" height="').concat(n,'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>')};function n(t){return document.querySelector(t)}function e(t,n,e,o){var a=0<arguments.length&&void 0!==t?t:"div",c=1<arguments.length&&void 0!==n?n:"",i=2<arguments.length&&void 0!==e?e:null,r=3<arguments.length&&void 0!==o?o:null,s=document.createElement(a);return s.setAttribute("class","O_"+c),i&&i.appendChild(s),r&&(s.innerHTML=r),s}function o(t){for(;t.firstChild;)t.removeChild(t.firstChild)}function a(t,e){var o=n(t);o?o.addEventListener("click",e):console.warn("Octomments: ".concat(t," element doesn't exists in the DOM"))}var c="OCTOMMENTS_NEW_COMMENT_TEXT";return function(i,r){var s=r instanceof HTMLElement?r:n(r);if(!s)throw Error("Octomments: invalid container selector.");var u=e("div","root",s),m=function n(c,i){var r,s={},u=i.options,m=u.issueNumber,d=u.github,l=d.owner,f=d.repo,g="https://github.com/".concat(l,"/").concat(f,"/issues/").concat(m),v=[];function h(t){o(c),e("div","error",c,"<div>".concat(t,"</div>"))}return s.loading=function(){0===v.length?(o(c),e("div","summary",c,'\n      <div>Loading comments ...</div>\n        <div>\n          <a href="'.concat(g,'" target="_blank">\n            ').concat(t(14),"\n          </a>\n        </div>"))):r.innerHTML='\n        <div></div>\n        <div class="'.concat("O_",'more-comments-loading"><small>loading ...</small></div>\n      ')},s.noComments=function(){o(c)},s.newComment=function(t){s.data(t)},s.data=function(n,s){v=v.concat(n),o(c),e("div","summary",c,'\n        <div id="'.concat("O_",'num-of-comments">').concat(v.length," comment").concat(1!==v.length?"s":"",'</div>\n        <div>\n          <a href="').concat(g,'" target="_blank">\n            ').concat(t(14),"\n          </a>\n        </div>\n      ")),v.forEach(function(n){var o,a;e("div","comment",c,'\n          <div class="'.concat("O_",'comment_left">\n            <img src="').concat(n.author.avatarUrl,'" />\n          </div>\n          <div class="').concat("O_",'comment_right">\n            <div class="').concat("O_",'comment_heading">\n              <strong>').concat(n.author.login,"</strong>\n              <small> - ").concat((o=n.updatedAt,a=new Date(o),"".concat(a.getFullYear(),"-").concat((a.getMonth()+1).toString().padStart(2,"0"),"-").concat(a.getDate().toString().padStart(2,"0"))),'</small>\n              <a href="').concat(n.url,'" target="_blank" class="').concat("O_",'right">').concat(t(16),'</a>\n            </div>\n            <div class="').concat("O_",'comment_body">\n              ').concat(n.body,"\n            </div>\n          </div>\n        "))}),s&&s.next&&(r=e("div","comment ".concat("O_","more-comments"),c,'\n          <div></div>\n          <div>\n            <a href="javascript:void(0);" id="'.concat("O_",'more-comments-link">\n              <small>... load more comments</small>\n            </a>\n          </div>\n        ')),a("#".concat("O_","more-comments-link"),function(){i.page(s.next.page)}))},i.on(i.ERROR,function(t,n){console.log("-errror",t,n),1===n?h("Issue <strong>#".concat(number,"</strong> doesn't exists at <a href=\"https://github.com/").concat(l,"/").concat(f,'/issues" target="_blank">').concat(f," repo</a>.")):2!==n&&3!==n&&4!==n||(h('There is a problem fetching the comments. Wait a bit and click <a href="javascript:void(0);" id="'.concat("O_",'comments_try_again">here</a> to try again.')),a("#".concat("O_","comments_try_again"),i.initComments))}),s}(e("div","comments",u),i),d=function t(i,r){var s={};function u(t){var e,o,i,s=r.LS.getItem(c)||"",u=n("#".concat("O_","_submit_comment")),m=n("#".concat("O_","_textarea"));a("#".concat("O_","_submit_comment"),function(){u.disabled=!0,t(m.value)}),e="#".concat("O_","_textarea"),o=function(t){""===t.target.value?u.disabled=!0:u.disabled=!1,r.LS.setItem(c,t.target.value)},(i=n(e))?i.addEventListener("keyup",o):console.warn("Octomments: ".concat(e," element doesn't exists in the DOM")),""===s?u.disabled=!0:m.value=s}function m(t,n,a){var c=2<arguments.length&&void 0!==a?a:i;return(!(1<arguments.length&&void 0!==n)||n)&&o(i),e("div","error_user",c,"<div>".concat(t,"</div>"))}return i.style.display="none",s.loading=function(){o(i),e("small","comment",i,'\n      <div></div>\n      <div class="'.concat("O_",'loading-user"><small>Loading user ...</small></div>\n      '))},s.noUser=function(t){o(i),e("div","comment",i,'\n        <div class="'.concat("O_",'comment_left" id="').concat("O_",'new_comment">\n          <div class="').concat("O_",'avatar_placeholder"></div>\n        </div>\n        <div class="').concat("O_",'comment_right">\n          <textarea id="').concat("O_",'_textarea" placeholder="I think ..."></textarea>\n          <button id="').concat("O_",'_submit_comment">Log in and comment</button>\n        </div>\n      ')),u(function(){window.location.href=t})},s.form=function(t,c){var m=r.user;if(!m)return s.loading();o(i),e("div","comment",i,'\n        <div class="'.concat("O_",'comment_left" id="').concat("O_",'new_comment">\n          <img src="').concat(m.avatarUrl,'" />\n        </div>\n        <div class="').concat("O_",'comment_right">\n          <textarea id="').concat("O_",'_textarea" placeholder="I think ..."></textarea>\n          <div class="').concat("O_",'buttonbox"><a href="javascript:void(0);" id="').concat("O_",'logout" class="').concat("O_","right ").concat("O_",'logout"><small>Log out</small></a>\n          <button id="').concat("O_",'_submit_comment">Comment</button>\n        </div></div>\n      ')),u(function(t){r.add(t)}),a("#".concat("O_","logout"),function(){r.logout()}),c&&setTimeout(function(){n("#".concat("O_","_textarea")).focus()},100)},s.newCommentSaved=function(){r.LS.removeItem(c)},r.on(r.ERROR,function(t,e){1===e?o(i):5===e?(r.logout(!1),s.noUser(r.generateNewCommentURL())):6===e||7===e||10===e?(m('There is a problem initializing your user. Wait a bit and click <a href="javascript:void(0);" id="'.concat("O_",'user_try_again">here</a> to try again.')),a("#".concat("O_","user_try_again"),r.initUser)):8===e?m("There is a problem posting your comment. Please try again in a couple of minutes.",!1,n(".".concat("O_","comment_right"))).style.marginTop="1em":9===e&&(r.logout(!1),m('Not authorized. Click <a href="javascript:void(0);" id="'.concat("O_",'user_login">here</a> to login again.')),a("#".concat("O_","user_login"),r.initUser))}),r.on(r.COMMENTS_LOADED,function(){i.style.display="block"}),s}(e("div","new-comment",u),i);i.on(i.COMMENTS_LOADING,m.loading).on(i.COMMENTS_LOADED,m.data).on(i.USER_LOADING,d.loading).on(i.USER_NONE,d.noUser).on(i.USER_LOADED,d.form).on(i.COMMENT_SAVING,function(){n("#".concat("O_","new_comment")).style.opacity=.4;var t=n("#".concat("O_","_submit_comment")),e=n("#".concat("O_","_textarea"));t.disabled=!0,e.disabled=!0,t.innerHTML="Posting your comment ..."}).on(i.COMMENT_SAVED,function(t){d.newCommentSaved(),d.form(),m.newComment(t)})}});